# Continuous Integration with Valgrind

ValgrindCI provides tools to integrate [valgrind](https://valgrind.org/) in your Continuous Integration process.

ValgrindCI parses the XML output of valgrind to sum up in a report all the results of a valgrind run and, based on these results, help you trigger the proper actions for the continuation - or abortion - of your CI job.
- ValgrindCI can report the number of errors or,
- Errors can be filtered before issuing a report (for example leak errors only).
- ValgrindCI can display a summary of the errors found by valgrind. Optionally, this summary can be filtered.
- ValgrindCI can generate an HTML report to examine the errors directly within your code.

## Installation
### Install from the sources
#### Pre-requisites
ValgrindCI uses the Python packages [`defusedxml`](https://github.com/tiran/defusedxml) and [`jinja2`](https://palletsprojects.com/p/jinja/).
If you are building ValgrindCI from source, these dependencies can be installed with `pip`
```
> pip install -r requirements.txt
```
#### Build and install the package
ValgrindCI uses the `setuptools` to build. The package can then be installed with `pip`
```
> python setup.py bdist_wheel
> pip install valgrindci --no-index -f dist/valgrindci*.whl
```
### Download and install with `pip`
ValgrindCI is a tool written in Python and can be installed from `pip`.
```
> pip install valgrindci
```

## How to use
ValgrindCI is a command tool designed to be executed within a job of your favorite Continuous Integration framework.

Valgrind must be run with options `--xml=yes` and `--xml-file`.
```
> valgrind --tool=memcheck --xml=yes --xml-file==/path/to/output_file.xml my_executable --options-of-my-executable
```
### Minimum report
ValgrindCI can then be invoked to parse the XML output file and report the total number of errors found by valgrind.
```python
from ValgrindCI.parse import ValgrindData

data = ValgrindData()
data.parse('/path/to/output_file.xml')
print(data.get_num_errors()) # Output the total number of errors.
```
Depending on the number of errors, you can stop the current job or proceed.

### Filtering data
Valgrind can generate a significant amount of errors, not all of which might be relevant to your project. In that case, ValgrindCI can filter data to report only the errors that are of interest to you.

For example, if you only need errors generated by leaks definitely lost then you can filter the data with the method `filter_error_kind()` to report that kind of errors:
```python
from ValgrindCI.parse import ValgrindData

data = ValgrindData()
data.parse('/path/to/output_file.xml')
# Output the number of errors for leaks definitely lost.
print(data.filter_error_kind('Leak_DefinitelyLost').get_num_errors()) 
```
There are some other filters available to select a subset of source files or a particular line of code.

### Summary report of errors
You can request ValgrindCI to print a summary report in case errors have been reported by valgrind.

This data can be filtered (error kinds, source files, etc.) before printing the summary report.

```python
from ValgrindCI.parse import ValgrindData
from ValgrindCI.report import report

data = ValgrindData()
data.parse('/path/to/output_file.xml')
data_leaks = data.filter_error_kind('Leak_DefinitelyLost')
if data_leaks.get_num_errors():
    print(report(data_leaks))
```
